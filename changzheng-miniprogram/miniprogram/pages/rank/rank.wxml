<!--pages/rank/rank.wxml-->
<view class="container">
  <!-- Tabåˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'total' ? 'active' : ''}}" data-tab="total" bindtap="switchTab">
      <text>æ€»æ¦œ</text>
    </view>
    <view class="tab-item {{activeTab === 'grade' ? 'active' : ''}}" data-tab="grade" bindtap="switchTab">
      <text>å¹´çº§æ¦œ</text>
    </view>
  </view>

  <!-- å¹´çº§æ ‡é¢˜ -->
  <view class="grade-header" wx:if="{{activeTab === 'grade' && userGrade}}">
    <text>{{userGrade}} æ’è¡Œæ¦œ</text>
  </view>

  <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
  <scroll-view 
    class="rank-list" 
    scroll-y
    refresher-enabled
    bindrefresherrefresh="onPullDownRefresh"
  >
    <!-- æ€»æ¦œå†…å®¹ -->
    <block wx:if="{{activeTab === 'total'}}">
      <!-- æ•°æ®å°‘äº3æ¡æ—¶æ˜¾ç¤ºæ™®é€šåˆ—è¡¨ -->
      <view class="rank-items" wx:if="{{rankList.length > 0 && rankList.length < 3}}">
        <view 
          class="rank-item"
          wx:for="{{rankList}}"
          wx:key="userId"
          data-item="{{item}}"
          bindtap="onUserTap"
        >
          <view class="item-rank top-rank-{{index + 1}}">{{index + 1}}</view>
          <image class="item-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-name">{{item.realName}}</text>
            <text class="item-extra">{{item.grade || ''}} {{item.className || ''}}</text>
          </view>
          <view class="item-value">
            <text class="value-num">{{item.totalMileage}}</text>
            <text class="value-unit">km</text>
          </view>
        </view>
      </view>

      <!-- å‰ä¸‰å -->
      <view class="top-three" wx:if="{{rankList.length >= 3}}">
        <!-- ç¬¬äºŒå -->
        <view class="top-item second" data-item="{{rankList[1]}}" bindtap="onUserTap">
          <view class="top-rank">2</view>
          <image class="top-avatar" src="{{rankList[1].avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="top-name ellipsis">{{rankList[1].realName}}</text>
          <text class="top-major ellipsis">{{rankList[1].className || ''}}</text>
          <view class="top-value">{{rankList[1].totalMileage}}<text>km</text></view>
        </view>
        
        <!-- ç¬¬ä¸€å -->
        <view class="top-item first" data-item="{{rankList[0]}}" bindtap="onUserTap">
          <view class="crown">ğŸ‘‘</view>
          <view class="top-rank">1</view>
          <image class="top-avatar" src="{{rankList[0].avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="top-name ellipsis">{{rankList[0].realName}}</text>
          <text class="top-major ellipsis">{{rankList[0].className || ''}}</text>
          <view class="top-value">{{rankList[0].totalMileage}}<text>km</text></view>
        </view>
        
        <!-- ç¬¬ä¸‰å -->
        <view class="top-item third" data-item="{{rankList[2]}}" bindtap="onUserTap">
          <view class="top-rank">3</view>
          <image class="top-avatar" src="{{rankList[2].avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="top-name ellipsis">{{rankList[2].realName}}</text>
          <text class="top-major ellipsis">{{rankList[2].className || ''}}</text>
          <view class="top-value">{{rankList[2].totalMileage}}<text>km</text></view>
        </view>
      </view>

      <!-- å…¶ä»–æ’å -->
      <view class="rank-items">
        <view 
          class="rank-item"
          wx:for="{{rankList}}"
          wx:key="userId"
          wx:if="{{index >= 3}}"
          data-item="{{item}}"
          bindtap="onUserTap"
        >
          <view class="item-rank">{{index + 1}}</view>
          <image class="item-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-name">{{item.realName}}</text>
            <text class="item-extra">{{item.grade || ''}} {{item.className || ''}}</text>
          </view>
          <view class="item-value">
            <text class="value-num">{{item.totalMileage}}</text>
            <text class="value-unit">km</text>
          </view>
        </view>
      </view>
    </block>

    <!-- å¹´çº§æ¦œå†…å®¹ï¼ˆæ˜¾ç¤ºåŒå¹´çº§ç”¨æˆ·æ’åï¼‰ -->
    <block wx:if="{{activeTab === 'grade'}}">
      <!-- æ•°æ®å°‘äº3æ¡æ—¶æ˜¾ç¤ºæ™®é€šåˆ—è¡¨ -->
      <view class="rank-items" wx:if="{{rankList.length > 0 && rankList.length < 3}}">
        <view 
          class="rank-item"
          wx:for="{{rankList}}"
          wx:key="userId"
          data-item="{{item}}"
          bindtap="onUserTap"
        >
          <view class="item-rank top-rank-{{index + 1}}">{{index + 1}}</view>
          <image class="item-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-name">{{item.realName}}</text>
            <text class="item-extra">{{item.className || ''}}</text>
          </view>
          <view class="item-value">
            <text class="value-num">{{item.totalMileage}}</text>
            <text class="value-unit">km</text>
          </view>
        </view>
      </view>

      <!-- å‰ä¸‰å -->
      <view class="top-three" wx:if="{{rankList.length >= 3}}">
        <!-- ç¬¬äºŒå -->
        <view class="top-item second" data-item="{{rankList[1]}}" bindtap="onUserTap">
          <view class="top-rank">2</view>
          <image class="top-avatar" src="{{rankList[1].avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="top-name ellipsis">{{rankList[1].realName}}</text>
          <text class="top-major ellipsis">{{rankList[1].className || ''}}</text>
          <view class="top-value">{{rankList[1].totalMileage}}<text>km</text></view>
        </view>
        
        <!-- ç¬¬ä¸€å -->
        <view class="top-item first" data-item="{{rankList[0]}}" bindtap="onUserTap">
          <view class="crown">ğŸ‘‘</view>
          <view class="top-rank">1</view>
          <image class="top-avatar" src="{{rankList[0].avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="top-name ellipsis">{{rankList[0].realName}}</text>
          <text class="top-major ellipsis">{{rankList[0].className || ''}}</text>
          <view class="top-value">{{rankList[0].totalMileage}}<text>km</text></view>
        </view>
        
        <!-- ç¬¬ä¸‰å -->
        <view class="top-item third" data-item="{{rankList[2]}}" bindtap="onUserTap">
          <view class="top-rank">3</view>
          <image class="top-avatar" src="{{rankList[2].avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <text class="top-name ellipsis">{{rankList[2].realName}}</text>
          <text class="top-major ellipsis">{{rankList[2].className || ''}}</text>
          <view class="top-value">{{rankList[2].totalMileage}}<text>km</text></view>
        </view>
      </view>

      <!-- å…¶ä»–æ’å -->
      <view class="rank-items">
        <view 
          class="rank-item"
          wx:for="{{rankList}}"
          wx:key="userId"
          wx:if="{{index >= 3}}"
          data-item="{{item}}"
          bindtap="onUserTap"
        >
          <view class="item-rank">{{index + 1}}</view>
          <image class="item-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-name">{{item.realName}}</text>
            <text class="item-extra">{{item.className || ''}}</text>
          </view>
          <view class="item-value">
            <text class="value-num">{{item.totalMileage}}</text>
            <text class="value-unit">km</text>
          </view>
        </view>
      </view>
    </block>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="loading-more" wx:if="{{loading && page > 1}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && rankList.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && rankList.length === 0}}">
      <text>æš‚æ— æ’è¡Œæ•°æ®</text>
    </view>
  </scroll-view>

  <!-- æˆ‘çš„æ’å -->
  <view class="my-rank" wx:if="{{myRank && isLogin}}">
    <view class="my-rank-inner">
      <view class="my-rank-left">
        <view class="my-rank-num">{{myRank.rank || '-'}}<text>å</text></view>
        <image class="my-avatar" src="{{myRank.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="my-info">
          <text class="my-name">{{myRank.realName || 'æˆ‘'}}</text>
          <text class="my-extra">{{myRank.className || ''}}</text>
        </view>
      </view>
      <view class="my-rank-right">
        <text class="my-value">{{myRank.totalMileage || 0}}</text>
        <text class="my-unit">km</text>
      </view>
    </view>
  </view>

  <!-- æœªç™»å½•æç¤º -->
  <view class="login-tip" wx:if="{{!isLogin}}" bindtap="goLogin">
    <text>ç™»å½•æŸ¥çœ‹æ‚¨çš„æ’å</text>
  </view>
</view>
