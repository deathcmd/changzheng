# 云上重走长征路 - 使用文档

> 四川工商职业技术学院 · 智能制造与信息工程学院

## 一、项目简介

「云上重走长征路」是一款将微信运动步数与红色教育相结合的微信小程序。用户通过日常走路积累里程，虚拟重走25000里长征路，解锁沿途历史节点并学习红色教育内容。

### 核心功能

| 功能模块 | 说明 |
|---------|------|
| 步数同步 | 自动同步微信运动步数，按比例换算为长征里程 |
| 长征地图 | 可视化展示长征路线图、17个历史节点及用户当前位置 |
| 节点解锁 | 累计里程达标后解锁节点，学习视频/音频/图文内容 |
| 排行榜 | 个人、班级、年级三维度排行榜 |
| 学生认证 | 绑定学号后参与班级/年级统计（仅限本院学生） |
| 成就系统 | 完成特定目标获得徽章成就 |

---

## 二、技术架构

### 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Java | 17 | 开发语言 |
| Spring Boot | 3.2.0 | 基础框架 |
| Spring Cloud | 2023.0.0 | 微服务框架 |
| Spring Cloud Alibaba | 2023.0.0 | Nacos注册/配置中心 |
| MyBatis Plus | 3.5.5 | ORM框架 |
| MySQL | 8.0 | 关系型数据库 |
| Redis | 7.x | 缓存中间件 |
| JWT (jjwt) | 0.12.3 | 身份认证 |
| Druid | 1.2.20 | 数据库连接池 |
| Knife4j | 4.4.0 | API文档 |
| Hutool | 5.8.24 | 工具库 |

### 前端技术栈

| 技术 | 说明 |
|------|------|
| 微信小程序原生 | 用户端（C端） |
| Vue 3 + Vite | 管理后台（B端） |
| Element Plus | 后台UI组件库 |
| ECharts | 数据图表 |
| Pinia | 状态管理 |

---

## 三、项目结构

```
changzheng/
├── changzheng-common/        # 公共模块（实体、工具、异常、JWT）
├── changzheng-gateway/       # API网关（路由转发、Token校验）
├── changzheng-auth/          # 认证服务（微信登录、学生认证、用户管理）
├── changzheng-sport/         # 运动服务（步数同步、里程计算、进度跟踪）
├── changzheng-content/       # 内容服务（节点管理、学习内容）
├── changzheng-rank/          # 排行服务（排行榜、成就系统）
├── changzheng-admin/         # 管理服务（后台管理API、学生导入）
├── changzheng-admin-web/     # 管理后台前端（Vue3 + Element Plus）
├── changzheng-miniprogram/   # 微信小程序
│   └── miniprogram/
│       ├── pages/            # 页面目录
│       │   ├── index/        # 首页
│       │   ├── map/          # 长征地图
│       │   ├── rank/         # 排行榜
│       │   ├── mine/         # 我的
│       │   ├── node/         # 节点详情
│       │   ├── authorize/    # 登录授权
│       │   ├── bind/         # 学生认证
│       │   ├── profile/      # 编辑资料
│       │   └── ...
│       ├── utils/            # 工具函数
│       └── config/           # 配置文件
├── sql/                      # 数据库脚本
├── docker/                   # Docker配置
├── deploy.sh                 # 一键部署脚本
└── docker-compose.yml        # Docker编排
```

---

## 四、开发环境配置

### 4.1 环境要求

| 软件 | 版本要求 | 说明 |
|------|---------|------|
| JDK | 17+ | 后端开发 |
| Maven | 3.8+ | 项目构建 |
| Node.js | 18+ | 前端开发 |
| MySQL | 8.0+ | 数据库 |
| Redis | 7.x | 缓存（可选） |
| 微信开发者工具 | 最新版 | 小程序开发 |

### 4.2 数据库初始化

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE changzheng_db DEFAULT CHARSET utf8mb4;"

# 执行初始化脚本
mysql -u root -p changzheng_db < sql/V1__init_schema.sql
mysql -u root -p changzheng_db < sql/V2__init_data.sql
```

### 4.3 后端配置

修改 `changzheng-auth/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/changzheng_db
    username: root
    password: 你的数据库密码
  data:
    redis:
      host: localhost
      port: 6379

wx:
  miniapp:
    appid: 你的小程序AppID
    secret: 你的小程序Secret
```

---

## 五、启动运行

### 5.1 后端服务

```bash
# 编译整个项目
cd changzheng
mvn clean package -DskipTests

# 启动认证服务
java -jar changzheng-auth/target/changzheng-auth-1.0.0.jar

# 启动管理服务（新终端）
java -jar changzheng-admin/target/changzheng-admin-1.0.0.jar
```

**服务端口：**

| 服务 | 端口 |
|------|------|
| Gateway | 8080 |
| Auth | 8081 |
| Sport | 8082 |
| Admin | 8085 |

### 5.2 管理后台前端

```bash
cd changzheng-admin-web
npm install
npm run dev

# 访问 http://localhost:3000
# 默认账号：admin / admin123
```

### 5.3 微信小程序

1. 打开微信开发者工具
2. 导入项目 `changzheng-miniprogram` 目录
3. 填入你的小程序 AppID
4. 点击编译预览

> **Mock模式**：开发时可开启Mock模式，无需启动后端  
> 编辑 `miniprogram/config/index.js`，设置 `useMock: true`

---

## 六、功能使用指南

### 6.1 微信小程序

#### 首页
- 显示今日步数、累计里程、当前节点
- 下拉刷新同步最新步数
- 点击「同步步数」手动更新

#### 长征地图
- **地图模式**：显示长征路线和节点标记
- **列表模式**：查看所有节点及解锁状态
- 点击已解锁节点进入学习

#### 排行榜
- 个人排行：全校用户里程排名
- 班级排行：已认证用户的班级排名
- 年级排行：已认证用户的年级排名

#### 我的
- 点击头像进入学生认证
- 设置 > 更改头像或昵称
- 查看运动记录、成就徽章

### 6.2 管理后台

#### 仪表盘
- 用户总数、今日活跃、平均里程
- 趋势图表、节点访问量排行

#### 学生管理
- 下载Excel模板导入学生信息
- 支持筛选：年级、专业、班级、认证状态
- 导出学生数据

**导入模板格式：**

| 学号 | 姓名 | 性别 | 专业 | 班级 | 年级 |
|------|------|------|------|------|------|
| 2024031294 | 李荣为 | 男 | 软件技术 | 软件24349 | 2024级 |

---

## 七、核心配置

### 7.1 步数换算规则

```
换算比例：2000步 = 1公里
长征总里程：25000公里
每日最大有效步数：30000步
```

### 7.2 Mock模式配置

**小程序** `miniprogram/config/index.js`：

```javascript
const currentEnv = 'dev'  // 'dev' 使用Mock, 'prod' 使用真实API

const ENV = {
  dev: {
    baseUrl: 'http://localhost:8080/api',
    useMock: true   // 开启Mock模式
  },
  prod: {
    baseUrl: 'https://你的域名/api',
    useMock: false  // 关闭Mock模式
  }
}
```

---

## 八、API接口

### 认证服务 `/api/auth`

| 接口 | 方法 | 说明 |
|------|------|------|
| /wx/login | POST | 微信小程序登录 |
| /bindStudent | POST | 学生身份认证 |
| /profile | POST | 更新头像昵称 |
| /userInfo | GET | 获取用户信息 |

### 运动服务 `/api/sport`

| 接口 | 方法 | 说明 |
|------|------|------|
| /steps/sync | POST | 同步微信运动步数 |
| /mileage/overview | GET | 里程概览 |
| /steps/daily | GET | 每日步数记录 |

### 内容服务 `/api/content`

| 接口 | 方法 | 说明 |
|------|------|------|
| /route/nodes | GET | 路线节点列表 |
| /node/{id} | GET | 节点详情 |
| /user/progress | GET | 用户节点进度 |

### 排行榜服务 `/api/rank`

| 接口 | 方法 | 说明 |
|------|------|------|
| /personal | GET | 个人排行榜 |
| /class | GET | 班级排行榜 |
| /grade | GET | 年级排行榜 |
| /my | GET | 我的排名 |

---

## 九、常见问题

### Q1: 小程序无法获取步数？
- 微信开发者工具无法获取真实运动数据
- 使用真机预览测试，或开启Mock模式

### Q2: 编译报错找不到类？
先安装公共模块：
```bash
cd changzheng-common && mvn clean install
```

### Q3: 退出登录后头像昵称丢失？
已修复。系统会自动保留用户设置的头像和昵称。

### Q4: 学生认证后能解绑吗？
不能。学生认证采用永久绑定机制，认证后不可解除。

---

## 十、注意事项

1. **用户范围**：本系统仅限四川工商职业技术学院智能制造与信息工程学院学生使用
2. **隐私保护**：学号和姓名采用AES加密存储
3. **小程序审核**：正式发布需配置HTTPS域名

---

如有问题，请联系项目开发团队或辅导员。
