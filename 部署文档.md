# 云上重走长征路 - 部署指南

> 四川工商职业技术学院 · 智能制造与信息工程学院

本指南提供了“云上重走长征路”项目的全面部署说明。项目采用微服务架构，支持手动部署、脚本自动化部署以及 Docker 容器化部署。

---

## 一、 项目概述

“云上重走长征路”是一个集运动打卡、长征知识学习、全校排名于一体的综合性平台。
- **后端**：Spring Boot 3.x, Spring Cloud Alibaba (Nacos, Sentinel, Gateway)
- **前端**：Vue 3, Vite, Element-Plus
- **小程序**：原生微信小程序
- **中间件**：MySQL 8.0, Redis 7.0, RocketMQ 5.x

---

## 二、 环境要求

### 2.1 硬件配置
| 配置项 | 最低要求 | 推荐配置 |
|-------|---------|---------|
| CPU | 2核 | 4核 |
| 内存 | 4GB | 8GB (微服务较多，建议8G以上) |
| 硬盘 | 40GB SSD | 100GB SSD |

### 2.2 基础环境
- **操作系统**: Ubuntu 22.04 LTS (推荐) 或 CentOS 7.9+
- **JDK**: OpenJDK 17
- **Node.js**: 18.x
- **数据库**: MySQL 8.0
- **缓存**: Redis 7.0
- **构建工具**: Maven 3.8+

---

## 三、 准备工作

### 3.1 获取代码
```bash
sudo mkdir -p /opt/changzheng
cd /opt/changzheng
# 请将项目代码通过 Git 或 SCP 上传至此目录
```

### 3.2 准备环境变量
在项目运行前，请准备好以下信息：
- 微信小程序 `AppID` 和 `AppSecret`
- 服务器公网 IP 或 域名
- 数据库及 Redis 密码

---

## 四、 数据库与中间件设置

### 4.1 MySQL & Redis 初始化
如果使用脚本或 Docker 部署，此步骤可跳过。

**MySQL 配置：**
```sql
CREATE DATABASE changzheng_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE nacos_config DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**导入数据：**
执行 `sql/V1__init_schema.sql` 和 `sql/V2__init_data.sql`。

### 4.2 Nacos 启动 (微服务核心)
Nacos 用于服务发现和配置管理。
```bash
# 下载并启动 Nacos (单机模式)
sh bin/startup.sh -m standalone
```

---

## 五、 后端部署

项目提供三种部署方式，请根据需求选择其中一种。

### 方式 A：自动化脚本部署 (推荐用于 Ubuntu)
```bash
chmod +x deploy.sh
sudo ./deploy.sh
```
脚本会自动安装依赖、构建项目并配置 Nginx。

### 方式 B：Docker 容器化部署 (推荐用于生产)
```bash
# 1. 确保已安装 Docker 和 Docker Compose
# 2. 启动所有服务
docker-compose up -d

# 3. 查看运行状态
docker-compose ps
```

### 方式 C：手动构建与部署
```bash
# 1. 构建整个项目
mvn clean package -DskipTests

# 2. 运行各模块 (建议使用 Systemd 管理)
nohup java -jar changzheng-gateway/target/changzheng-gateway-1.0.0.jar &
nohup java -jar changzheng-auth/target/changzheng-auth-1.0.0.jar &
# ... 其他子模块
```

---

## 六、 前端部署 (管理后台)

### 6.1 编译打包
```bash
cd changzheng-admin-web
npm install
npm run build
```

### 6.2 Nginx 配置
将打包后的 `dist` 目录内容放置于 `/var/www/changzheng-admin`。

**Nginx 示例配置：**
```nginx
server {
    listen 80;
    server_name your_domain.com;

    location / {
        root /var/www/changzheng-admin;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/; # 指向网关
    }
}
```

---

## 七、 微信小程序配置

1. 使用 **微信开发者工具** 打开 `changzheng-miniprogram`。
2. 修改 `miniprogram/config/index.js` 中的 `baseUrl`：
   ```javascript
   prod: {
     baseUrl: 'https://your_domain.com/api',
     useMock: false
   }
   ```
3. 在小程序后台设置「服务器域名」，添加你的 API 域名。

---

## 八、 安全与运维建议

### 8.1 启用 HTTPS
使用 Certbot 快速配置：
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your_domain.com
```

### 8.2 日志查看
- **Docker**: `docker logs -f changzheng-auth`
- **Systemd**: `journalctl -u changzheng-auth -f`
- **文件**: `tail -f logs/changzheng-auth.log`

### 8.3 备份建议
- 每日凌晨自动导出数据库：`mysqldump -u root -p changzheng_db > backup.sql`
- 建议异地备份。

---

## 九、 常见问题 (FAQ)

**Q: Nacos 无法连接数据库？**
A: 检查 `conf/application.properties` 中的数据库连接信息，并确保 MySQL 允许 Nacos 所在的 IP 访问。

**Q: 小程序报「域名不合法」？**
A: 请在微信公众平台配置 request 合法域名，并确保使用的是 HTTPS 协议。

**Q: 内存不足导致服务挂掉？**
A: 微服务占用内存较多，可通过 JVM 参数限制：`-Xms256m -Xmx512m`。

---

© 2024 四川工商职业技术学院 · 智造信息学院
